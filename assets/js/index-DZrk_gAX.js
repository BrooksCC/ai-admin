import{j as e,u as O,a as C}from"./index-Db-n9AuA.js";import{r as y,u as G}from"./react-DNsX-D9n.js";import{g as X,i as Z,s as ee}from"./character-BcIvpXh_.js";import{B as te}from"./BatchDeleteButton-Bt_weDdV.js";import{D as ae}from"./DeleteButton-BMniQVoK.js";import{E as re}from"./EditButton-BUedPtj1.js";import{S as P,a as u,b as se,R as oe}from"./SearchRow-q_BHF2rT.js";import{S as ne}from"./SearchContainer-BiQmlDqb.js";import{u as le,a as ie,S as ce}from"./useTable-fH3mNaAk.js";import{A as R,c as de,F as b,I as k,p as pe,q as ue,B as N,s as B,r as ge,g as i,S as v,a as me,f as F,k as he,v as xe}from"./antd-Bzi-nNZC.js";import"./echarts-C9Czxobr.js";import"./Button-_vf7nIrW.js";import"./useWindowSize-CaV-WCuS.js";import"./useMutation-DP40qn5U.js";import"./usePageTransfer-d_dI9PVS.js";const fe=({onLoginSuccess:r,message:g})=>{const{t:s}=O(),[I,m]=y.useState(!1),S=C(d=>d.loginService),h=g||B,x=async d=>{m(!0);try{await S({identifier:d.username,password:d.password}),h.success(s("page.login.loginSuccess")),r&&r()}catch(f){console.error(s("page.login.loginFailed"),f),h.error(s("page.login.loginFailed")+(f instanceof Error?`: ${f.message}`:""))}finally{m(!1)}};return e.jsx("div",{style:{display:"flex",justifyContent:"center",alignItems:"center",height:"100vh"},children:e.jsx(de,{title:s("page.login.title"),style:{width:400},children:e.jsxs(b,{name:"login_form",initialValues:{remember:!0,username:"admin",password:"admin"},onFinish:x,autoComplete:"off",children:[e.jsx(b.Item,{name:"username",rules:[{required:!0,message:s("page.login.validation.usernameRequired")}],children:e.jsx(k,{prefix:e.jsx(pe,{}),placeholder:s("page.login.userNamePlaceholder")})}),e.jsx(b.Item,{name:"password",rules:[{required:!0,message:s("page.login.validation.passwordRequired")}],children:e.jsx(k.Password,{prefix:e.jsx(ue,{}),placeholder:s("page.login.passwordPlaceholder")})}),e.jsx(b.Item,{children:e.jsx(N,{type:"primary",htmlType:"submit",loading:I,style:{width:"100%"},children:s("page.login.login")})})]})})})},je=r=>{const{message:g}=R.useApp();return e.jsx(fe,{...r,message:g})},ve=r=>e.jsx(R,{children:e.jsx(je,{...r})}),ye=[{label:"创建时间",value:"createdAt"},{label:"更新时间",value:"updatedAt"},{label:"人气",value:"popularity"},{label:"聊天数",value:"chats"}],be=[{label:"升序",value:"asc"},{label:"降序",value:"desc"}],we=[{label:"全部",value:""},{label:"公开",value:"public"},{label:"私有",value:"private"}],Ce=[{label:"全部",value:""},{label:"活跃",value:"active"},{label:"禁用",value:"disabled"},{label:"待审核",value:"pending"}];function ze(){const{t:r}=O(),g=y.useRef(null),[s,I]=y.useState([]),m=G(),[S,h]=y.useState(!1),x=C(t=>t.isLogin),d=C(t=>t.logoutService),f=C(t=>t.accessToken);y.useEffect(()=>{async function t(){try{const a=await X();a&&a.categories&&I(a.categories)}catch(a){console.error("Failed to fetch categories:",a)}}x&&t()},[x]);const D=()=>{const t=document.createElement("input");t.type="file",t.accept="image/png",t.onchange=async a=>{var c;const n=(c=a.target.files)==null?void 0:c[0];if(n)try{h(!0);const l=new FormData;l.append("file",n),l.append("format","silly_tavern"),l.append("preservedFileName",`character-${Date.now()}.png`);const p=await Z(l,f||void 0);p&&p.id&&(B.success("角色导入成功"),m(`/card/${p.id}`))}catch(l){console.error("导入角色失败:",l),B.error(`导入角色失败: ${l.message||"请稍后重试"}`)}finally{h(!1)}},t.click()};async function $(t){const a={page:t.page||1,limit:t.pageSize||20,search:t.search,categoryId:t.categoryId,categoryIds:t.categoryIds,tags:t.tags,creatorId:t.creatorId,sortBy:t.sortBy||"popularity",sortOrder:t.sortOrder||"desc"};t.visibility&&(a.visibility=t.visibility),t.status&&(a.status=t.status),(a.limit===null||a.limit===void 0)&&(a.limit=20),(a.page===null||a.page===void 0)&&(a.page=1),console.log("调用searchCharacters的参数:",JSON.stringify(a));try{const{characters:o,totalCount:n}=await ee(a);return{list:o,total:n}}catch(o){return console.error("Failed to fetch characters:",o),i.error({title:"获取数据失败",content:"无法加载角色列表，请稍后重试。"}),{list:[],total:0}}}const{listContainerProps:A,tableScrollY:E}=le(),{form:T,tableProps:j,isLoading:z,selectedIsEmpty:q,selectedCount:L,handleReset:w,handleSearch:_}=ie({key:"card-page-table",pagination:!0,listApiFn:$,scrollY:E,selectable:!0,formInitialValues:{search:"",categoryId:"",visibility:"",status:"",sortBy:"popularity",sortOrder:"desc"},columns:[{title:r("page.card.avatar"),dataIndex:"avatarUrl",width:80,render:(t,a)=>e.jsx(ge,{src:t,alt:a.name})},{title:r("page.card.name"),dataIndex:"name",ellipsis:!0},{title:r("page.card.category"),dataIndex:"categories",width:100,render:t=>e.jsx(e.Fragment,{children:t==null?void 0:t.map(a=>a.name).join(", ")})},{title:r("page.card.tags"),dataIndex:"tags",ellipsis:!0,render:t=>e.jsx(e.Fragment,{children:t==null?void 0:t.map(a=>e.jsx("span",{className:"mr-1",children:a},a))})},{title:r("page.card.popularity"),dataIndex:"popularity",width:100,sorter:!0},{title:r("page.card.chats"),dataIndex:"chats",width:100,sorter:!0},{title:r("page.card.description"),dataIndex:"description",ellipsis:!0},{title:r("page.dataTableExample.action"),key:"actions",fixed:"right",width:100,render:(t,a)=>e.jsxs(e.Fragment,{children:[e.jsx(re,{type:"text",size:"small",noText:!0,onClick:()=>W(a.id)}),e.jsx(ae,{type:"text",size:"small",noText:!0,onConfirm:()=>U(a.id)})]})}]});function M(t){console.log("查看角色详情:",t),m(`/card/${t}`)}function W(t){console.log("Edit character with id:",t),i.info({title:"编辑角色",content:`将要编辑 ID 为 ${t} 的角色。`})}function U(t){console.log("Delete character with id:",t),i.confirm({title:"确认删除",content:`确定要删除 ID 为 ${t} 的角色吗？`,onOk:async()=>{try{i.success({content:"删除成功"}),w()}catch{i.error({title:"删除失败",content:"删除角色时出错。"})}}})}function Y(){var a;const t=(a=j.rowSelection)==null?void 0:a.selectedRowKeys;if(!Array.isArray(t)||t.length===0){console.warn("No items selected for batch delete.");return}i.confirm({title:"确认批量删除",content:`确定要删除选中的 ${L} 个角色吗？`,onOk:async()=>{try{i.success({content:"批量删除成功"}),w()}catch{i.error({title:"批量删除失败",content:"批量删除角色时出错。"})}}})}const J=()=>{i.confirm({title:"确认退出",content:"确定要退出登录吗？",onOk:()=>{d()}})},K=e.jsxs(b,{ref:g,form:T,colon:!1,autoComplete:"off",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("div",{}),e.jsx(N,{type:"primary",danger:!0,onClick:J,children:"退出登录"})]}),e.jsxs(ne,{actions:e.jsxs(e.Fragment,{children:[e.jsxs(me,{children:[e.jsx(se,{loading:z,onClick:_}),e.jsx(oe,{onClick:w})]}),e.jsx(F,{type:"vertical"}),e.jsx(te,{disabled:q,count:L,onConfirm:Y}),e.jsx(F,{type:"vertical"}),e.jsx(N,{type:"primary",icon:e.jsx(he,{}),loading:S,onClick:D,children:"导入角色"})]}),children:[e.jsxs(P,{children:[e.jsx(u,{name:"search",label:r("page.card.searchPlaceholder","搜索"),children:e.jsx(k,{placeholder:r("page.card.searchPlaceholder","按名称、描述搜索...")})}),e.jsx(u,{name:"categoryId",label:r("page.card.category","分类"),children:e.jsx(v,{placeholder:r("page.card.categoryPlaceholder","选择分类"),allowClear:!0,options:s.map(t=>({label:t.name,value:t.id}))})}),e.jsx(u,{name:"visibility",label:r("page.card.visibility","可见性"),children:e.jsx(v,{placeholder:r("page.card.visibilityPlaceholder","选择可见性"),allowClear:!0,options:we})}),e.jsx(u,{name:"status",label:r("page.card.status","状态"),children:e.jsx(v,{placeholder:r("page.card.statusPlaceholder","选择状态"),allowClear:!0,options:Ce})})]}),e.jsxs(P,{children:[e.jsx(u,{name:"sortBy",label:r("page.card.sortBy","排序字段"),children:e.jsx(v,{placeholder:r("page.card.sortByPlaceholder","选择排序字段"),options:ye})}),e.jsx(u,{name:"sortOrder",label:r("page.card.sortOrder","排序方式"),children:e.jsx(v,{placeholder:r("page.card.sortOrderPlaceholder","选择排序方式"),options:be})})]})]})]});function V(){w()}if(!x)return e.jsx(ve,{onLoginSuccess:V});const H=()=>{const t=j.dataSource||[];return e.jsx("div",{className:"grid-container",style:{maxHeight:"calc(100vh - 360px)",overflowY:"auto",padding:"10px 5px"},children:e.jsx("div",{className:"grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6",children:t.map(a=>{var o,n,c;return e.jsxs("div",{className:"bg-transparent overflow-hidden cursor-pointer hover:transform hover:scale-[1.03] transition-all",onClick:()=>M(a.id),children:[e.jsxs("div",{className:"relative aspect-square mb-2",children:[e.jsx("div",{className:"w-full h-full rounded-md overflow-hidden",children:e.jsx("img",{src:a.avatarUrl,alt:a.name,className:`w-full h-full object-cover ${a.shouldBlurAvatar?"blur-sm filter":""}`,onError:l=>{const p=l.target;p.onerror=null,p.src=`https://ui-avatars.com/api/?name=${encodeURIComponent(a.name)}&background=random`}})}),e.jsx("div",{className:"absolute bottom-2 left-2",children:e.jsx("span",{className:"bg-card/80 backdrop-blur-sm text-foreground px-3 py-1 rounded-full text-sm",children:((o=a.categories)==null?void 0:o.length)>0?a.categories[0].name:"角色"})})]}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-foreground text-lg font-medium mb-1",children:a.name}),e.jsx("p",{className:"text-muted-foreground text-sm line-clamp-2 mb-2",children:a.shortIntroduction||"暂无简介"}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("div",{className:"flex items-center gap-1",children:e.jsx("span",{className:"text-muted-foreground text-xs",children:(n=a.tags)==null?void 0:n.join(", ")})}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-4 w-4 text-muted-foreground",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"})}),e.jsx("span",{className:"text-muted-foreground text-xs",children:a.favoriteCount||0})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-4 w-4 text-yellow-400",fill:"currentColor",viewBox:"0 0 24 24",stroke:"none",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"})}),e.jsx("span",{className:"text-muted-foreground text-xs",children:((c=a.popularity)==null?void 0:c.toFixed(1))||"0.0"})]})]})]})]})]},a.id)})})})},Q=()=>{if(!j.pagination)return null;if(typeof j.pagination=="object"){const{current:t,pageSize:a,total:o,onChange:n}=j.pagination;return e.jsx("div",{className:"mt-4 py-2 flex justify-end",style:{position:"sticky",bottom:0,width:"100%",backgroundColor:"var(--background)",zIndex:10},children:e.jsx(xe,{current:t,pageSize:a,total:o,onChange:n,showSizeChanger:!0,showQuickJumper:!0,showTotal:c=>`共 ${c} 条记录`})})}return null};return e.jsxs(ce,{...A,searchForm:K,children:[H(),Q()]})}export{ze as default};
