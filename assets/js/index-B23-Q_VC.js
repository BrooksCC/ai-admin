import{j as e,D as ge,S as xe}from"./index-BpF1OpJE.js";import{r as v,n as Ie,u as Ae}from"./react-DNsX-D9n.js";import{S as J,B as U,w as Te,x as le,y as re,F as V,z as be,g as se,I as Se,s as z,E as ke,G as De}from"./antd-Bzi-nNZC.js";import{B as fe}from"./Button-DSSUBtr-.js";import{a as je,g as Ee,u as Me}from"./character-WxcypDso.js";import{A as Re}from"./admin-service-CzzxyH7d.js";import"./echarts-C9Czxobr.js";const Oe=({value:t=[],onChange:s})=>{const[n,o]=v.useState(""),[l,y]=v.useState(""),x=Array.isArray(t)?t:[];v.useEffect(()=>{x.length>0&&!n&&(o(x[0]),y(x[0]))},[x,n]);const d=u=>{o(u),y(u)},p=u=>{y(u.target.value)},M=()=>{if(!l.trim()||!s)return;const u=[...x],h=u.indexOf(n),f=[...u];h>=0?f[h]=l:f.push(l),s(f),o(""),y("")},R=u=>{if(!s)return;const h=x.filter(f=>f!==u);s(h),n===u&&(o(""),y(""))};return e.jsxs("div",{className:"mb-4",children:[e.jsx("div",{className:"mb-2",children:e.jsx(J,{placeholder:"选择要编辑的问候语或创建新问候语",onChange:d,value:n,allowClear:!0,style:{width:"100%"},options:x.map(u=>({label:e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:[e.jsx("span",{style:{flexGrow:1,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"},children:u.length>25?`${u.substring(0,25)}...`:u}),e.jsx(U,{type:"text",danger:!0,icon:e.jsx(Te,{}),onClick:h=>{h.stopPropagation(),R(u)},size:"small",style:{marginLeft:"8px"}})]}),value:u}))})}),e.jsx("div",{className:"mb-2",children:e.jsx(le,{value:l,onChange:p,autoSize:{minRows:1,maxRows:15},placeholder:"编辑问候语内容"})}),e.jsx("div",{className:"flex justify-end",children:e.jsx(U,{type:"primary",size:"small",onClick:M,disabled:!l.trim(),children:n?"更新问候语":"添加问候语"})})]})},{Text:ie}=re,Ve=({character:t,renderFormItem:s,handleAuditCharacter:n,auditing:o,handleFormChange:l})=>t?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"p-4 bg-rose-50 rounded-md mb-4 border border-rose-200",children:e.jsx(ie,{type:"danger",children:"此区域用于审核角色信息。请确认所有内容符合社区规范和平台政策。"})}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-6",children:[e.jsx("div",{className:"col-span-1",children:e.jsx("div",{className:"aspect-square overflow-hidden rounded-lg mb-4 border-2 border-rose-300",children:e.jsx("img",{src:t.avatarUrl,alt:t.name,className:"w-full h-full object-cover",style:{filter:t.shouldBlurAvatar?"blur(8px)":"none"}})})}),e.jsxs("div",{className:"col-span-2",children:[s("avatarUrl","角色头像URL"),s("visibility","可见性","select"),s("characterVersion","角色版本"),e.jsxs("div",{className:"p-3 bg-gray-50 rounded-lg border border-gray-200 mb-4",children:[e.jsx(ie,{strong:!0,children:"审核状态: "}),e.jsx(ie,{type:t.auditStatus==="approved"?"success":t.auditStatus==="rejected"?"danger":"warning",children:t.auditStatus==="approved"?"已通过":t.auditStatus==="rejected"?"已拒绝":t.auditStatus==="pending"?"待审核":"无审核状态"})]}),e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("div",{className:"font-normal text-base",children:"模糊显示头像"}),e.jsx(V.Item,{name:"shouldBlurAvatar",valuePropName:"checked",className:"mb-0",style:{marginBottom:0},children:e.jsx(be,{onChange:l})})]}),e.jsxs("div",{className:"mt-4 flex justify-end",children:[e.jsx(U,{type:"primary",danger:!0,className:"mr-2",onClick:()=>n(!1),loading:o,children:"拒绝"}),e.jsx(U,{type:"primary",onClick:()=>n(!0),loading:o,children:"通过审核"})]})]})]})]}):null;var we;let Ce;function _e(t,s,n,o,l,y){var x,d,p,M,R,u,h,f=Symbol.metadata||Symbol.for("Symbol.metadata"),j=Object.defineProperty,_=Object.create,L=[_(null),_(null)],P=s.length;function k(a,I,A){return function(m,g){I&&(g=m,m=t);for(var D=0;D<a.length;D++)g=a[D].apply(m,A?[g]:[]);return A?g:m}}function b(a,I,A,m){if(typeof a!="function"&&(m||a!==void 0))throw new TypeError(I+" must "+(A||"be")+" a function"+(m?"":" or undefined"));return a}function W(a,I,A,m,g,D,$,S,r,i,c){function w(N){if(!c(N))throw new TypeError("Attempted to access private element on non-instance")}var O=[].concat(I[0]),B=I[3],K=!$,Y=g===1,ce=g===3,de=g===4,Q=g===2;function X(N,F,he){return function(ee,pe){return F&&(pe=ee,ee=a),he&&he(ee),C[N].call(ee,pe)}}if(!K){var C={},ne=[],G=ce?"get":de||Y?"set":"value";if(r?(i||Y?C={get:ve(function(){return B(this)},m,"get"),set:function(N){I[4](this,N)}}:C[G]=B,i||ve(C[G],m,Q?"":G)):i||(C=Object.getOwnPropertyDescriptor(a,m)),!i&&!r){if((d=L[+S][m])&&(d^g)!=7)throw Error("Decorating two elements with the same name ("+C[G].name+") is not supported yet");L[+S][m]=g<3?1:g}}for(var T=a,Z=O.length-1;Z>=0;Z-=A?2:1){var ue=b(O[Z],"A decorator","be",!0),me=A?O[Z-1]:void 0,ae={},H={kind:["field","accessor","method","getter","setter","class"][g],name:m,metadata:x,addInitializer:(function(N,F){if(N.v)throw new TypeError("attempted to call addInitializer after decoration was finished");b(F,"An initializer","be",!0),D.push(F)}).bind(null,ae)};if(K)d=ue.call(me,T,H),ae.v=1,b(d,"class decorators","return")&&(T=d);else if(H.static=S,H.private=r,d=H.access={has:r?c.bind():function(N){return m in N}},de||(d.get=r?Q?function(N){return w(N),C.value}:X("get",0,w):function(N){return N[m]}),Q||ce||(d.set=r?X("set",0,w):function(N,F){N[m]=F}),T=ue.call(me,Y?{get:C.get,set:C.set}:C[G],H),ae.v=1,Y){if(typeof T=="object"&&T)(d=b(T.get,"accessor.get"))&&(C.get=d),(d=b(T.set,"accessor.set"))&&(C.set=d),(d=b(T.init,"accessor.init"))&&ne.unshift(d);else if(T!==void 0)throw new TypeError("accessor decorators must return an object with get, set, or init properties or undefined")}else b(T,(i?"field":"method")+" decorators","return")&&(i?ne.unshift(T):C[G]=T)}return g<2&&$.push(k(ne,S,1),k(D,S,0)),i||K||(r?Y?$.splice(-1,0,X("get",S),X("set",S)):$.push(Q?C[G]:b.call.bind(C[G])):j(a,m,C)),T}function q(a){return j(a,f,{configurable:!0,enumerable:!0,value:x})}return x=_(x??null),R=[],u=function(a){a&&R.push(k(a))},h=function(a,I){for(var A=0;A<n.length;A++){var m=n[A],g=m[1],D=7&g;if((8&g)==a&&!D==I){var $=m[2],S=!!m[3],r=16&g;W(a?t:t.prototype,m,r,S?"#"+$:$e($),D,D<2?[]:a?M=M||[]:p=p||[],R,!!a,S,I,a&&S?function(i){return Ge(i)===t}:l)}}},h(8,0),h(0,0),h(8,1),h(0,1),u(p),u(M),d=R,P||q(t),{e:d,get c(){var a=[];return P&&[q(t=W(t,[s],o,t.name,5,a)),k(a,1)]}}}function $e(t){var s=Be(t,"string");return typeof s=="symbol"?s:s+""}function Be(t,s){if(typeof t!="object"||!t)return t;var n=t[Symbol.toPrimitive];if(n!==void 0){var o=n.call(t,s);if(typeof o!="object")return o;throw new TypeError("@@toPrimitive must return a primitive value.")}return(s==="string"?String:Number)(t)}function ve(t,s,n){typeof s=="symbol"&&(s=(s=s.description)?"["+s+"]":"");try{Object.defineProperty(t,"name",{configurable:!0,value:n?n+" "+s:s})}catch{}return t}function Ge(t){if(Object(t)!==t)throw TypeError("right-hand side of 'in' should be an object, got "+(t!==null?typeof t:"null"));return t}let Ne;class ze{async getModels(){try{return(await xe.models.getModels()).data}catch(s){throw console.error("Failed to get models:",s),s}}async generateText(s){try{const n={textGenerationRequestDto:s};return(await xe.models.generateText(n)).data}catch(n){throw console.error("Failed to generate text:",n),n}}}we=ze;[Ne,Ce]=_e(we,[ge,ge.Singleton],[],1).c;Ce();const ye=new Ne,Le=({renderFormItem:t,form:s,handleFormChange:n})=>{const[o,l]=v.useState({shortIntroduction:!1,introduction:!1}),[y,x]=v.useState(null),[d,p]=v.useState(!0),[M,R]=v.useState(null);v.useEffect(()=>{(async()=>{try{p(!0);const j=(await ye.getModels()).models.find(_=>_.name==="DeepSeek-V3");!j||!j.id?(R("DeepSeek-V3模型未找到"),console.error("DeepSeek-V3 model not found in available models")):x(j)}catch(f){R("获取模型列表失败"),console.error("Error fetching models:",f)}finally{p(!1)}})()},[]);const u=async(h,f)=>{if(console.log(h,f),!y){console.error("无法生成文本：DeepSeek-V3模型未找到或尚未加载");return}l(j=>({...j,[h]:!0}));try{const j=s.getFieldValue("description");if(!j){console.warn(`Cannot generate text for ${f}: 'Character Description' is empty.`);return}const _=`根据以下角色描述，生成一个不超过50个汉字的简介，纯字符串，不要包含任何其他信息，不要使用markdown格式：

 角色描述: "${j}"`,L=`根据以下角色描述，生成一个不超过300个汉字的简介，需要包含角色性格、背景、经历、爱好、特长、目标、梦想等，纯字符串，不要包含任何其他信息，不要使用markdown格式：

 角色描述: "${j}"`,P={prompt:h==="shortIntroduction"?_:L,modelId:y.id,extraParams:{}},k=await ye.generateText(P),b=k.content;console.log(b),typeof b=="string"?(s.setFieldsValue({[h]:b}),n()):console.error(`Failed to generate text for ${f}: Invalid response format from AI.`,k)}catch(j){console.error(`Error generating text for ${f}:`,j)}finally{l(j=>({...j,[h]:!1}))}};return d?e.jsx("div",{className:"text-center py-4",children:"正在加载可用模型..."}):M?e.jsx("div",{className:"text-center py-4 text-red-500",children:M}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"grid grid-cols-3 gap-4 mb-4 items-end",children:[e.jsx("div",{className:"col-span-1",children:t("categoryIds","角色分类","categories")}),e.jsx("div",{className:"col-span-1",children:t("tags","角色标签","tags")}),e.jsx("div",{className:"col-span-1",children:t("name","角色名称")})]}),e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"form-label",htmlFor:"shortIntroduction",children:"角色简介"}),e.jsxs("div",{className:"flex items-start gap-2",children:[e.jsx("div",{className:"flex-grow",children:t("shortIntroduction","","textarea")}),e.jsx(fe,{onClick:()=>u("shortIntroduction","角色简介"),disabled:o.shortIntroduction||!y,children:o.shortIntroduction?"生成中...":"AI 生成"})]})]}),e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"form-label",htmlFor:"introduction",children:"角色详细介绍"}),e.jsxs("div",{className:"flex items-start gap-2",children:[e.jsx("div",{className:"flex-grow",children:t("introduction","","textarea")}),e.jsx(fe,{onClick:()=>u("introduction","角色详细介绍"),disabled:o.introduction||!y,children:o.introduction?"生成中...":"AI 生成"})]})]}),t("description","角色描述","textarea"),t("greetings","备选问候语","greetingsEditor")]})},Pe=({renderFormItem:t})=>e.jsxs(e.Fragment,{children:[t("personality","性格特点","textarea"),t("backgroundStory","背景故事","textarea",{rows:6}),t("behaviors","行为习惯","textarea")]}),Ue=({renderFormItem:t})=>e.jsxs(e.Fragment,{children:[t("languageStyle","语言风格","textarea"),t("expressionStyle","表达方式","textarea"),t("firstMessage","首次发言","textarea"),t("scenario","场景设定","textarea")]}),qe=({renderFormItem:t})=>e.jsxs(e.Fragment,{children:[t("systemPrompt","系统提示词","textarea",{rows:6}),t("postHistoryInstructions","历史记录后指令","textarea"),t("creatorNotes","创作者笔记","textarea")]}),{Text:oe}=re,Ke=({character:t})=>t?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"p-4 bg-gray-50 rounded-md mb-4",children:e.jsx(oe,{type:"secondary",children:"这里显示了AI模型的相关设置，包括使用的模型、参数等。 这些设置通常由系统维护，部分设置需要管理员权限才能修改。"})}),t&&t.aiSettings&&Object.entries(t.aiSettings).map(([s,n])=>e.jsxs("div",{className:"mb-3",children:[e.jsxs(oe,{strong:!0,children:[s,":"," "]}),e.jsx(oe,{children:typeof n=="object"?JSON.stringify(n):String(n)})]},s))]}):null,{Text:E}=re,Fe=({character:t})=>{var s;return t?e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"p-4 border rounded-md",children:[e.jsx(E,{strong:!0,children:"创建时间: "}),e.jsx(E,{children:new Date(t.createdAt).toLocaleString()})]}),e.jsxs("div",{className:"p-4 border rounded-md",children:[e.jsx(E,{strong:!0,children:"更新时间: "}),e.jsx(E,{children:new Date(t.updatedAt).toLocaleString()})]}),e.jsxs("div",{className:"p-4 border rounded-md",children:[e.jsx(E,{strong:!0,children:"人气: "}),e.jsx(E,{children:t.popularity})]}),e.jsxs("div",{className:"p-4 border rounded-md",children:[e.jsx(E,{strong:!0,children:"聊天数: "}),e.jsx(E,{children:t.useCount})]}),e.jsxs("div",{className:"p-4 border rounded-md",children:[e.jsx(E,{strong:!0,children:"创建者: "}),e.jsx(E,{children:((s=t.creator)==null?void 0:s.username)||"未知"})]}),e.jsxs("div",{className:"p-4 border rounded-md",children:[e.jsx(E,{strong:!0,children:"ID: "}),e.jsx(E,{children:t.id})]})]}):null},Je=({visible:t,isApprove:s,auditing:n,auditReason:o,commonRejectReasons:l,onOk:y,onCancel:x,onReasonChange:d})=>e.jsx(se,{title:s?"通过审核":"拒绝理由",open:t,onOk:y,onCancel:x,confirmLoading:n,children:s?e.jsx(Se,{placeholder:"输入通过理由（可选）",defaultValue:"符合平台规范",onChange:p=>d(p.target.value)}):e.jsxs(e.Fragment,{children:[e.jsx(J,{style:{width:"100%",marginBottom:"10px"},placeholder:"选择拒绝理由",onChange:p=>d(p),allowClear:!0,children:l.map(p=>e.jsx(J.Option,{value:p,children:p},p))}),e.jsx(le,{placeholder:"或输入自定义拒绝理由",value:o,onChange:p=>d(p.target.value),autoSize:{minRows:3,maxRows:5}})]})}),{Title:We,Text:Ye}=re,te=["name","description","shortIntroduction","introduction","avatarUrl","shouldBlurAvatar","personality","backgroundStory","behaviors","languageStyle","expressionStyle","firstMessage","scenario","messageExamples","systemPrompt","postHistoryInstructions","greetings","characterVersion","creatorNotes","sillyTavernRawData","categoryIds","tags","visibility"],He=[{label:"公开",value:"public"},{label:"私有",value:"private"}];function nt(){const s=Ie().id,n=Ae(),[o]=V.useForm(),[l,y]=v.useState(null),[x,d]=v.useState([]),[p,M]=v.useState(!0),[R,u]=v.useState(!1),[h,f]=v.useState(!1),[j,_]=v.useState({}),[L,P]=v.useState(!1),[k,b]=v.useState({visible:!1,isApprove:!1}),[W,q]=v.useState("");v.useEffect(()=>{if(!s){z.error("角色ID无效"),n("/card");return}async function r(){try{M(!0);const c=await je(s);y(c);const w={};te.forEach(O=>{O in c&&(w[O]=c[O])}),c.categories&&Array.isArray(c.categories)&&(w.categoryIds=c.categories.map(O=>O.id)),o.setFieldsValue(w),_(w)}catch(c){console.error("获取角色详情失败:",c),z.error("获取角色详情失败，请稍后重试")}finally{M(!1)}}async function i(){try{const c=await Ee();c&&c.categories&&d(c.categories)}catch(c){console.error("获取类别数据失败:",c)}}r(),i()},[s,o,n]);const a=()=>{f(!0);const r=o.getFieldsValue();_(r),localStorage.setItem(`character_edit_${s}`,JSON.stringify(r))},I=async()=>{if(!s){z.error("角色ID无效");return}try{await o.validateFields();const r=o.getFieldsValue(),i={};te.forEach(w=>{w in r&&(i[w]=r[w])}),u(!0),await Me(s,i),localStorage.removeItem(`character_edit_${s}`),z.success("角色更新成功"),f(!1);const c=await je(s);y(c)}catch(r){console.error("更新角色失败:",r),z.error(`更新角色失败: ${r.message||"请稍后重试"}`)}finally{u(!1)}},A=()=>{se.confirm({title:"确认取消",content:"您有未保存的更改，确定要取消吗？",onOk:()=>{if(l){const r={};te.forEach(i=>{i in l&&(r[i]=l[i])}),o.setFieldsValue(r)}localStorage.removeItem(`character_edit_${s}`),f(!1)}})},m=()=>{h?se.confirm({title:"确认返回",content:"您有未保存的更改，确定要返回吗？",onOk:()=>n("/card")}):n("/card")},g=async r=>{if(!s){z.error("角色ID无效");return}if(h){se.confirm({title:"未保存的更改",content:"角色有未保存的更改，请先保存更改后再进行审核。",okText:"保存并审核",cancelText:"取消",onOk:async()=>{try{await I(),b({visible:!0,isApprove:r})}catch(i){console.error("保存并审核失败:",i)}}});return}b({visible:!0,isApprove:r})},D=async(r,i)=>{try{P(!0);const c={status:r?"approved":"rejected",reason:i},w=await Re.auditCharacter(s,"",c);y(w),z.success(r?"角色已通过审核":"角色已被拒绝")}catch(c){console.error("审核角色失败:",c),z.error(`审核失败: ${c.message||"请稍后重试"}`)}finally{P(!1),b({visible:!1,isApprove:!1}),q("")}},$=["不符合平台规范","头像内容不适宜","描述内容不适宜","对话示例不适宜","背景故事内容不适宜","行为习惯内容不适宜","系统提示词不适宜"],S=(r,i,c="input",w)=>{const O=te.includes(r),{placeholder:B}=w||{};if(!O&&l)return e.jsx(V.Item,{label:i,name:r,children:e.jsx("div",{className:"read-only-field",children:c==="textarea"?e.jsx("pre",{className:"whitespace-pre-wrap",children:l[r]}):e.jsx(Ye,{children:l[r]})})});if(c==="greetingsEditor")return e.jsx(V.Item,{label:i,name:r,valuePropName:"value",children:e.jsx(Oe,{onChange:a})});switch(c){case"textarea":return e.jsx(V.Item,{label:i,name:r,children:e.jsx(le,{placeholder:B,onChange:a,autoSize:{minRows:1,maxRows:15}})});case"switch":return e.jsx(V.Item,{label:i,name:r,valuePropName:"checked",children:e.jsx(be,{onChange:a})});case"select":return e.jsx(V.Item,{label:i,name:r,children:e.jsx(J,{placeholder:B,options:He,onChange:a})});case"tags":return e.jsx(V.Item,{label:i,name:r,children:e.jsx(J,{mode:"tags",placeholder:B||"请输入标签，按回车确认",onChange:a})});case"categories":return e.jsx(V.Item,{label:i,name:r,children:e.jsx(J,{mode:"multiple",placeholder:B||"请选择分类",options:x.map(K=>({label:K.name,value:K.id})),onChange:a})});default:return e.jsx(V.Item,{label:i,name:r,children:e.jsx(Se,{placeholder:B,onChange:a})})}};return p?e.jsx("div",{className:"flex items-center justify-center h-full",children:e.jsx(ke,{size:"large",tip:"正在加载角色详情...",spinning:!0,children:e.jsx("div",{className:"p-12"})})}):e.jsxs("div",{className:"p-6",children:[e.jsxs("div",{className:"flex justify-between items-center mb-6",children:[e.jsx(We,{level:3,children:(l==null?void 0:l.name)||"角色详情"}),e.jsxs("div",{children:[e.jsx(U,{onClick:m,className:"mr-2",children:"返回"}),h&&e.jsxs(e.Fragment,{children:[e.jsx(U,{onClick:A,className:"mr-2",children:"取消"}),e.jsx(U,{type:"primary",onClick:I,loading:R,children:"保存"})]})]})]}),e.jsx(Je,{visible:k.visible,isApprove:k.isApprove,auditing:L,auditReason:W,commonRejectReasons:$,onOk:()=>D(k.isApprove,W||(k.isApprove?"符合平台规范":"不符合平台规范")),onCancel:()=>{b({visible:!1,isApprove:!1}),q("")},onReasonChange:q}),l&&e.jsx(V,{form:o,layout:"vertical",initialValues:j,children:e.jsx(De,{defaultActiveKey:"review",items:[{key:"review",label:"审核",children:e.jsx(Ve,{character:l,renderFormItem:S,handleAuditCharacter:g,auditing:L,handleFormChange:a})},{key:"keyOptions",label:"关键选项",children:e.jsx(Le,{renderFormItem:S,form:o,handleFormChange:a})},{key:"personality",label:"角色设定",children:e.jsx(Pe,{renderFormItem:S})},{key:"conversation",label:"对话设置",children:e.jsx(Ue,{renderFormItem:S})},{key:"advanced",label:"高级设置",children:e.jsx(qe,{renderFormItem:S})},{key:"aiSettings",label:"AI模型设置",children:e.jsx(Ke,{character:l})},{key:"stats",label:"统计信息",children:e.jsx(Fe,{character:l})}]})})]})}export{nt as default};
