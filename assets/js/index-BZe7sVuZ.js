import{j as e}from"./index-Cj6qzBOg.js";import{m as Z,u as ee,r as d}from"./react-Dz_Dwpfc.js";import{F as u,s as j,m as se,T as ae,B as b,j as T,I as U,S,n as B,o as q,p as H}from"./antd-CXRY_8Ve.js";import{a as J,g as re,u as te}from"./character-BtdHo9sS.js";import{A as ne}from"./admin-service-JyHIzBt2.js";import"./echarts-C9Czxobr.js";import"./sdk-service-CwzZtY5O.js";const{Title:ie,Text:i}=ae,{TabPane:f}=q,k=["name","description","avatarUrl","shouldBlurAvatar","personality","backgroundStory","behaviors","languageStyle","expressionStyle","firstMessage","scenario","messageExamples","systemPrompt","postHistoryInstructions","greetings","characterVersion","creatorNotes","sillyTavernRawData","categoryIds","tags","visibility"],ce=[{label:"公开",value:"public"},{label:"私有",value:"private"}],oe=({value:D=[],onChange:c})=>{const[h,m]=d.useState(""),[a,g]=d.useState(""),x=Array.isArray(D)?D:[];d.useEffect(()=>{x.length>0&&!h&&(m(x[0]),g(x[0]))},[x,h]);const F=o=>{m(o),g(o)},O=o=>{g(o.target.value)},A=()=>{if(!a.trim()||!c)return;const o=[...x],N=o.indexOf(h),v=[...o];N>=0?v[N]=a:v.push(a),c(v),m(""),g("")};return e.jsxs("div",{className:"mb-4",children:[e.jsx("div",{className:"mb-2",children:e.jsx(S,{placeholder:"选择要编辑的问候语或创建新问候语",onChange:F,value:h,allowClear:!0,style:{width:"100%"},options:x.map(o=>({label:o.length>30?`${o.substring(0,30)}...`:o,value:o}))})}),e.jsx("div",{className:"mb-2",children:e.jsx(B,{value:a,onChange:O,autoSize:{minRows:1,maxRows:15},placeholder:"编辑问候语内容"})}),e.jsx("div",{className:"flex justify-end",children:e.jsx(b,{type:"primary",size:"small",onClick:A,disabled:!a.trim(),children:h?"更新问候语":"添加问候语"})})]})};function pe(){var $;const c=Z().id,h=ee(),[m]=u.useForm(),[a,g]=d.useState(null),[x,F]=d.useState([]),[O,A]=d.useState(!0),[o,N]=d.useState(!1),[v,R]=d.useState(!1),[K,P]=d.useState({}),[V,L]=d.useState(!1),[C,E]=d.useState({visible:!1,isApprove:!1}),[_,I]=d.useState("");d.useEffect(()=>{if(!c){j.error("角色ID无效"),h("/card");return}async function s(){try{A(!0);const r=await J(c);g(r);const l={};k.forEach(y=>{y in r&&(l[y]=r[y])}),r.categories&&Array.isArray(r.categories)&&(l.categoryIds=r.categories.map(y=>y.id)),console.log("角色分类数据:",r.categories),console.log("表单初始化categoryIds:",l.categoryIds),m.setFieldsValue(l),P(l)}catch(r){console.error("获取角色详情失败:",r),j.error("获取角色详情失败，请稍后重试")}finally{A(!1)}}async function t(){try{const r=await re();r&&r.categories&&F(r.categories)}catch(r){console.error("获取类别数据失败:",r)}}s(),t()},[c,m,h]);const p=()=>{R(!0);const s=m.getFieldsValue();P(s),localStorage.setItem(`character_edit_${c}`,JSON.stringify(s))},G=async()=>{if(!c){j.error("角色ID无效");return}try{await m.validateFields();const s=m.getFieldsValue(),t={};k.forEach(l=>{l in s&&(t[l]=s[l])}),N(!0),await te(c,t),localStorage.removeItem(`character_edit_${c}`),j.success("角色更新成功"),R(!1);const r=await J(c);g(r)}catch(s){console.error("更新角色失败:",s),j.error(`更新角色失败: ${s.message||"请稍后重试"}`)}finally{N(!1)}},W=()=>{T.confirm({title:"确认取消",content:"您有未保存的更改，确定要取消吗？",onOk:()=>{if(a){const s={};k.forEach(t=>{t in a&&(s[t]=a[t])}),m.setFieldsValue(s)}localStorage.removeItem(`character_edit_${c}`),R(!1)}})},Y=()=>{v?T.confirm({title:"确认返回",content:"您有未保存的更改，确定要返回吗？",onOk:()=>h("/card")}):h("/card")},M=async s=>{if(!c){j.error("角色ID无效");return}if(v){T.confirm({title:"未保存的更改",content:"角色有未保存的更改，请先保存更改后再进行审核。",okText:"保存并审核",cancelText:"取消",onOk:async()=>{try{await G(),E({visible:!0,isApprove:s})}catch(t){console.error("保存并审核失败:",t)}}});return}E({visible:!0,isApprove:s})},Q=async(s,t)=>{try{L(!0);const r={status:s?"approved":"rejected",reason:t},l=await ne.auditCharacter(c,"",r);g(l),j.success(s?"角色已通过审核":"角色已被拒绝")}catch(r){console.error("审核角色失败:",r),j.error(`审核失败: ${r.message||"请稍后重试"}`)}finally{L(!1),E({visible:!1,isApprove:!1}),I("")}},X=["不符合平台规范","头像内容不适宜","描述内容不适宜","对话示例不适宜","背景故事内容不适宜","行为习惯内容不适宜","系统提示词不适宜"],n=(s,t,r="input",l)=>{const y=k.includes(s),{placeholder:w}=l||{};if(!y&&a)return e.jsx(u.Item,{label:t,name:s,children:e.jsx("div",{className:"read-only-field",children:r==="textarea"?e.jsx("pre",{className:"whitespace-pre-wrap",children:a[s]}):e.jsx(i,{children:a[s]})})});if(r==="greetingsEditor")return e.jsx(u.Item,{label:t,name:s,valuePropName:"value",children:e.jsx(oe,{onChange:p})});switch(r){case"textarea":return e.jsx(u.Item,{label:t,name:s,children:e.jsx(B,{placeholder:w,onChange:p,autoSize:{minRows:1,maxRows:15}})});case"switch":return e.jsx(u.Item,{label:t,name:s,valuePropName:"checked",children:e.jsx(H,{onChange:p})});case"select":return e.jsx(u.Item,{label:t,name:s,children:e.jsx(S,{placeholder:w,options:ce,onChange:p})});case"tags":return e.jsx(u.Item,{label:t,name:s,children:e.jsx(S,{mode:"tags",placeholder:w||"请输入标签，按回车确认",onChange:p})});case"categories":return e.jsx(u.Item,{label:t,name:s,children:e.jsx(S,{mode:"multiple",placeholder:w||"请选择分类",options:x.map(z=>({label:z.name,value:z.id})),onChange:p})});default:return e.jsx(u.Item,{label:t,name:s,children:e.jsx(U,{placeholder:w,onChange:p})})}};return O?e.jsx("div",{className:"flex items-center justify-center h-full",children:e.jsx(se,{size:"large",tip:"正在加载角色详情..."})}):e.jsxs("div",{className:"p-6",children:[e.jsxs("div",{className:"flex justify-between items-center mb-6",children:[e.jsx(ie,{level:3,children:(a==null?void 0:a.name)||"角色详情"}),e.jsxs("div",{children:[e.jsx(b,{onClick:Y,className:"mr-2",children:"返回"}),v&&e.jsxs(e.Fragment,{children:[e.jsx(b,{onClick:W,className:"mr-2",children:"取消"}),e.jsx(b,{type:"primary",onClick:G,loading:o,children:"保存"})]})]})]}),e.jsx(T,{title:C.isApprove?"通过审核":"拒绝理由",open:C.visible,onOk:()=>Q(C.isApprove,_||(C.isApprove?"符合平台规范":"不符合平台规范")),onCancel:()=>{E({visible:!1,isApprove:!1}),I("")},confirmLoading:V,children:C.isApprove?e.jsx(U,{placeholder:"输入通过理由（可选）",defaultValue:"符合平台规范",onChange:s=>I(s.target.value)}):e.jsxs(e.Fragment,{children:[e.jsx(S,{style:{width:"100%",marginBottom:"10px"},placeholder:"选择拒绝理由",onChange:s=>I(s),allowClear:!0,children:X.map(s=>e.jsx(S.Option,{value:s,children:s},s))}),e.jsx(B,{placeholder:"或输入自定义拒绝理由",value:_,onChange:s=>I(s.target.value),autoSize:{minRows:3,maxRows:5}})]})}),a&&e.jsx(u,{form:m,layout:"vertical",initialValues:K,children:e.jsxs(q,{defaultActiveKey:"review",children:[e.jsxs(f,{tab:"审核",children:[e.jsx("div",{className:"p-4 bg-rose-50 rounded-md mb-4 border border-rose-200",children:e.jsx(i,{type:"danger",children:"此区域用于审核角色信息。请确认所有内容符合社区规范和平台政策。"})}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-6",children:[e.jsx("div",{className:"col-span-1",children:e.jsx("div",{className:"aspect-square overflow-hidden rounded-lg mb-4 border-2 border-rose-300",children:e.jsx("img",{src:a.avatarUrl,alt:a.name,className:"w-full h-full object-cover",style:{filter:a.shouldBlurAvatar?"blur(8px)":"none"}})})}),e.jsxs("div",{className:"col-span-2",children:[n("avatarUrl","角色头像URL"),n("visibility","可见性","select"),n("characterVersion","角色版本"),e.jsxs("div",{className:"p-3 bg-gray-50 rounded-lg border border-gray-200 mb-4",children:[e.jsx(i,{strong:!0,children:"审核状态: "}),e.jsx(i,{type:a.auditStatus==="approved"?"success":a.auditStatus==="rejected"?"danger":"warning",children:a.auditStatus==="approved"?"已通过":a.auditStatus==="rejected"?"已拒绝":a.auditStatus==="pending"?"待审核":"无审核状态"})]}),e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("div",{className:"font-normal text-base",children:"模糊显示头像"}),e.jsx(u.Item,{name:"shouldBlurAvatar",valuePropName:"checked",className:"mb-0",style:{marginBottom:0},children:e.jsx(H,{onChange:p})})]}),e.jsxs("div",{className:"mt-4 flex justify-end",children:[e.jsx(b,{type:"primary",danger:!0,className:"mr-2",onClick:()=>M(!1),loading:V,children:"拒绝"}),e.jsx(b,{type:"primary",onClick:()=>M(!0),loading:V,children:"通过审核"})]})]})]})]},"review"),e.jsxs(f,{tab:"关键选项",children:[e.jsxs("div",{className:"grid grid-cols-3 gap-4 mb-4 items-end",children:[e.jsx("div",{className:"col-span-1",children:n("categoryIds","角色分类","categories")}),e.jsx("div",{className:"col-span-1",children:n("tags","角色标签","tags")}),e.jsx("div",{className:"col-span-1",children:n("name","角色名称")})]}),n("description","角色描述","textarea"),n("messageExamples","对话示例","textarea",{placeholder:"输入对话示例，每行一个回复"}),n("greetings","备选问候语","greetingsEditor")]},"keyOptions"),e.jsxs(f,{tab:"角色设定",children:[n("personality","性格特点","textarea"),n("backgroundStory","背景故事","textarea",{}),n("behaviors","行为习惯","textarea")]},"personality"),e.jsxs(f,{tab:"对话设置",children:[n("languageStyle","语言风格","textarea"),n("expressionStyle","表达方式","textarea"),n("firstMessage","首次发言","textarea"),n("scenario","场景设定","textarea")]},"conversation"),e.jsxs(f,{tab:"高级设置",children:[n("systemPrompt","系统提示词","textarea",{}),n("postHistoryInstructions","历史记录后指令","textarea"),n("creatorNotes","创作者笔记","textarea")]},"advanced"),e.jsxs(f,{tab:"AI模型设置",children:[e.jsx("div",{className:"p-4 bg-gray-50 rounded-md mb-4",children:e.jsx(i,{type:"secondary",children:"这里显示了AI模型的相关设置，包括使用的模型、参数等。 这些设置通常由系统维护，部分设置需要管理员权限才能修改。"})}),a&&a.aiSettings&&Object.entries(a.aiSettings).map(([s,t])=>e.jsxs("div",{className:"mb-3",children:[e.jsxs(i,{strong:!0,children:[s,":"," "]}),e.jsx(i,{children:typeof t=="object"?JSON.stringify(t):String(t)})]},s))]},"aiSettings"),e.jsx(f,{tab:"统计信息",children:e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"p-4 border rounded-md",children:[e.jsx(i,{strong:!0,children:"创建时间: "}),e.jsx(i,{children:new Date(a.createdAt).toLocaleString()})]}),e.jsxs("div",{className:"p-4 border rounded-md",children:[e.jsx(i,{strong:!0,children:"更新时间: "}),e.jsx(i,{children:new Date(a.updatedAt).toLocaleString()})]}),e.jsxs("div",{className:"p-4 border rounded-md",children:[e.jsx(i,{strong:!0,children:"人气: "}),e.jsx(i,{children:a.popularity})]}),e.jsxs("div",{className:"p-4 border rounded-md",children:[e.jsx(i,{strong:!0,children:"聊天数: "}),e.jsx(i,{children:a.chats})]}),e.jsxs("div",{className:"p-4 border rounded-md",children:[e.jsx(i,{strong:!0,children:"创建者: "}),e.jsx(i,{children:(($=a.creator)==null?void 0:$.username)||"未知"})]}),e.jsxs("div",{className:"p-4 border rounded-md",children:[e.jsx(i,{strong:!0,children:"ID: "}),e.jsx(i,{children:a.id})]})]})},"stats")]})})]})}export{pe as default};
