import{a as be,b as ke,u as ye,j as e}from"./index-DVVfHaA6.js";import{h as Se,r as U,u as Ie}from"./react-Dz_Dwpfc.js";import{g as Ce,i as Te,s as Le}from"./character-H73qJwms.js";import{B as De}from"./BatchDeleteButton-BJUgFdkQ.js";import{E as Ae,D as Re}from"./EditButton-BikjkQ3M.js";import{S as ge,a as N,b as Be,R as Ee}from"./SearchRow-BOPFbCy_.js";import{S as Oe}from"./SearchContainer-CD2j9xKu.js";import{u as Ne,a as Pe,S as _e}from"./useTable-5WC2S6dI.js";import{D as fe,S as H}from"./sdk-service-BLKJfM_e.js";import{c as $e,F as K,I as ne,f as ze,g as Fe,B as ie,s as te,h as qe,j as L,S as q,a as Ue,k as me,l as Ke,P as Me}from"./antd-DpJIrhNI.js";import"./echarts-C9Czxobr.js";import"./Button-Bn4Gp5ze.js";import"./useWindowSize-DSNN33pu.js";import"./useMutation-C2nYnVDP.js";import"./usePageTransfer-bIOoXG8A.js";var ve;let je;function We(t,a,o,n,j,A){var p,c,P,_,E,$,R,se=Symbol.metadata||Symbol.for("Symbol.metadata"),M=Object.defineProperty,C=Object.create,W=[C(null),C(null)],Y=a.length;function B(i,w,f){return function(l,d){w&&(d=l,l=t);for(var b=0;b<i.length;b++)d=i[b].apply(l,f?[d]:[]);return f?d:l}}function g(i,w,f,l){if(typeof i!="function"&&(l||i!==void 0))throw new TypeError(w+" must "+(f||"be")+" a function"+(l?"":" or undefined"));return i}function J(i,w,f,l,d,b,T,m,r,s,x){function y(h){if(!x(h))throw new TypeError("Attempted to access private element on non-instance")}var S=[].concat(w[0]),k=w[3],I=!T,z=d===1,le=d===3,ce=d===4,Q=d===2;function G(h,O,he){return function(Z,pe){return O&&(pe=Z,Z=i),he&&he(Z),u[h].call(Z,pe)}}if(!I){var u={},ae=[],D=le?"get":ce||z?"set":"value";if(r?(s||z?u={get:xe(function(){return k(this)},l,"get"),set:function(h){w[4](this,h)}}:u[D]=k,s||xe(u[D],l,Q?"":D)):s||(u=Object.getOwnPropertyDescriptor(i,l)),!s&&!r){if((c=W[+m][l])&&(c^d)!=7)throw Error("Decorating two elements with the same name ("+u[D].name+") is not supported yet");W[+m][l]=d<3?1:d}}for(var v=i,X=S.length-1;X>=0;X-=f?2:1){var de=g(S[X],"A decorator","be",!0),ue=f?S[X-1]:void 0,oe={},F={kind:["field","accessor","method","getter","setter","class"][d],name:l,metadata:p,addInitializer:(function(h,O){if(h.v)throw new TypeError("attempted to call addInitializer after decoration was finished");g(O,"An initializer","be",!0),b.push(O)}).bind(null,oe)};if(I)c=de.call(ue,v,F),oe.v=1,g(c,"class decorators","return")&&(v=c);else if(F.static=m,F.private=r,c=F.access={has:r?x.bind():function(h){return l in h}},ce||(c.get=r?Q?function(h){return y(h),u.value}:G("get",0,y):function(h){return h[l]}),Q||le||(c.set=r?G("set",0,y):function(h,O){h[l]=O}),v=de.call(ue,z?{get:u.get,set:u.set}:u[D],F),oe.v=1,z){if(typeof v=="object"&&v)(c=g(v.get,"accessor.get"))&&(u.get=c),(c=g(v.set,"accessor.set"))&&(u.set=c),(c=g(v.init,"accessor.init"))&&ae.unshift(c);else if(v!==void 0)throw new TypeError("accessor decorators must return an object with get, set, or init properties or undefined")}else g(v,(s?"field":"method")+" decorators","return")&&(s?ae.unshift(v):u[D]=v)}return d<2&&T.push(B(ae,m,1),B(b,m,0)),s||I||(r?z?T.splice(-1,0,G("get",m),G("set",m)):T.push(Q?u[D]:g.call.bind(u[D])):M(i,l,u)),v}function V(i){return M(i,se,{configurable:!0,enumerable:!0,value:p})}return p=C(p??null),E=[],$=function(i){i&&E.push(B(i))},R=function(i,w){for(var f=0;f<o.length;f++){var l=o[f],d=l[1],b=7&d;if((8&d)==i&&!b==w){var T=l[2],m=!!l[3],r=16&d;J(i?t:t.prototype,l,r,m?"#"+T:Ye(T),b,b<2?[]:i?_=_||[]:P=P||[],E,!!i,m,w,i&&m?function(s){return Ve(s)===t}:j)}}},R(8,0),R(0,0),R(8,1),R(0,1),$(P),$(_),c=E,Y||V(t),{e:c,get c(){var i=[];return Y&&[V(t=J(t,[a],n,t.name,5,i)),B(i,1)]}}}function Ye(t){var a=Je(t,"string");return typeof a=="symbol"?a:a+""}function Je(t,a){if(typeof t!="object"||!t)return t;var o=t[Symbol.toPrimitive];if(o!==void 0){var n=o.call(t,a);if(typeof n!="object")return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return(a==="string"?String:Number)(t)}function xe(t,a,o){typeof a=="symbol"&&(a=(a=a.description)?"["+a+"]":"");try{Object.defineProperty(t,"name",{configurable:!0,value:o?o+" "+a:a})}catch{}return t}function Ve(t){if(Object(t)!==t)throw TypeError("right-hand side of 'in' should be an object, got "+(t!==null?typeof t:"null"));return t}let we;class Qe{async login(a){try{return(await H.auth.login({loginRequestDto:a})).data}catch(o){throw console.error("Login failed:",o),o}}async register(a){try{return(await H.auth.register({registerRequestDto:a})).data}catch(o){throw console.error("Registration failed:",o),o}}async changePassword(a){try{await H.auth.changePassword({changePasswordRequestDto:a})}catch(o){throw console.error("Failed to change password:",o),o}}async oauthLogin(a){try{return(await H.auth.oauthLogin({oAuthRequestDto:a})).data}catch(o){throw console.error("OAuth login failed:",o),o}}}ve=Qe;[we,je]=We(ve,[fe,fe.Singleton],[],1).c;je();const re=new we,Ge=t=>re.login(t),Xe=t=>re.register(t),Ze=t=>re.changePassword(t),He=t=>re.oauthLogin(t),ee=Se()(be((t,a)=>({accessToken:null,refreshToken:null,isLogin:!1,userInfo:null,setAllToken:(o,n)=>t({accessToken:o,refreshToken:n}),clearAllToken:()=>t({accessToken:null,refreshToken:null}),setIsLogin:o=>t({isLogin:o}),setUserInfo:o=>t({userInfo:o}),clearUserInfo:()=>t({userInfo:null}),loginService:async o=>{try{const n=await Ge(o),j=n.token.accessToken;return a().setAllToken(j,""),a().setIsLogin(!0),a().setUserInfo(n.profile),n}catch(n){throw console.error("登录失败:",n),n}},registerService:async o=>{try{const n=await Xe(o),j=n.token.accessToken;return a().setAllToken(j,""),a().setIsLogin(!0),a().setUserInfo(n.profile),n}catch(n){throw console.error("注册失败:",n),n}},changePasswordService:async o=>{try{await Ze(o)}catch(n){throw console.error("修改密码失败:",n),n}},oauthLoginService:async o=>{try{const n=await He(o),j=n.token.accessToken;return a().setAllToken(j,""),a().setIsLogin(!0),a().setUserInfo(n.profile),n}catch(n){throw console.error("OAuth登录失败:",n),n}},logoutService:()=>{a().clearAllToken(),a().clearUserInfo(),a().setIsLogin(!1)}}),{name:ke("service-auth-storage"),partialize:t=>({accessToken:t.accessToken,refreshToken:t.refreshToken,isLogin:t.isLogin})})),et=({onLoginSuccess:t})=>{const{t:a}=ye(),[o,n]=U.useState(!1),j=ee(p=>p.loginService),A=async p=>{n(!0);try{await j({identifier:p.username,password:p.password}),te.success(a("page.login.loginSuccess")),t&&t()}catch(c){console.error(a("page.login.loginFailed"),c),te.error(a("page.login.loginFailed")+(c instanceof Error?`: ${c.message}`:""))}finally{n(!1)}};return e.jsx("div",{style:{display:"flex",justifyContent:"center",alignItems:"center",height:"100vh"},children:e.jsx($e,{title:a("page.login.title"),style:{width:400},children:e.jsxs(K,{name:"login_form",initialValues:{remember:!0,username:"admin",password:"admin"},onFinish:A,autoComplete:"off",children:[e.jsx(K.Item,{name:"username",rules:[{required:!0,message:a("page.login.validation.usernameRequired")}],children:e.jsx(ne,{prefix:e.jsx(ze,{}),placeholder:a("page.login.userNamePlaceholder")})}),e.jsx(K.Item,{name:"password",rules:[{required:!0,message:a("page.login.validation.passwordRequired")}],children:e.jsx(ne.Password,{prefix:e.jsx(Fe,{}),placeholder:a("page.login.passwordPlaceholder")})}),e.jsx(K.Item,{children:e.jsx(ie,{type:"primary",htmlType:"submit",loading:o,style:{width:"100%"},children:a("page.login.login")})})]})})})},tt=[{label:"创建时间",value:"createdAt"},{label:"更新时间",value:"updatedAt"},{label:"人气",value:"popularity"},{label:"聊天数",value:"chats"}],rt=[{label:"升序",value:"asc"},{label:"降序",value:"desc"}],st=[{label:"全部",value:""},{label:"公开",value:"public"},{label:"私有",value:"private"}],at=[{label:"全部",value:""},{label:"活跃",value:"active"},{label:"禁用",value:"disabled"},{label:"待审核",value:"pending"}];function jt(){const{t}=ye(),a=U.useRef(null),[o,n]=U.useState([]),j=Ie(),[A,p]=U.useState(!1),c=ee(r=>r.isLogin),P=ee(r=>r.logoutService),_=ee(r=>r.accessToken);U.useEffect(()=>{async function r(){try{const s=await Ce();s&&s.categories&&n(s.categories)}catch(s){console.error("Failed to fetch categories:",s)}}c&&r()},[c]);const E=()=>{const r=document.createElement("input");r.type="file",r.accept="image/png",r.onchange=async s=>{var S;const y=(S=s.target.files)==null?void 0:S[0];if(y)try{p(!0);const k=new FormData;k.append("file",y),k.append("format","silly_tavern"),k.append("preservedFileName",`character-${Date.now()}.png`);const I=await Te(k,_||void 0);I&&I.id&&(te.success("角色导入成功"),j(`/card/${I.id}`))}catch(k){console.error("导入角色失败:",k),te.error(`导入角色失败: ${k.message||"请稍后重试"}`)}finally{p(!1)}},r.click()};async function $(r){const s={page:r.page||1,limit:r.pageSize||20,search:r.search,categoryId:r.categoryId,categoryIds:r.categoryIds,tags:r.tags,creatorId:r.creatorId,sortBy:r.sortBy||"popularity",sortOrder:r.sortOrder||"desc"};r.visibility&&(s.visibility=r.visibility),r.status&&(s.status=r.status),(s.limit===null||s.limit===void 0)&&(s.limit=20),(s.page===null||s.page===void 0)&&(s.page=1),console.log("调用searchCharacters的参数:",JSON.stringify(s));try{const{characters:x,totalCount:y}=await Le(s);return{list:x,total:y}}catch(x){return console.error("Failed to fetch characters:",x),L.error({title:"获取数据失败",content:"无法加载角色列表，请稍后重试。"}),{list:[],total:0}}}const{listContainerProps:R,tableScrollY:se}=Ne(),{form:M,tableProps:C,isLoading:W,selectedIsEmpty:Y,selectedCount:B,handleReset:g,handleSearch:J}=Pe({key:"card-page-table",pagination:!0,listApiFn:$,scrollY:se,selectable:!0,formInitialValues:{search:"",categoryId:"",visibility:"",status:"",sortBy:"popularity",sortOrder:"desc"},columns:[{title:t("page.card.avatar"),dataIndex:"avatarUrl",width:80,render:(r,s)=>e.jsx(qe,{src:r,alt:s.name})},{title:t("page.card.name"),dataIndex:"name",ellipsis:!0},{title:t("page.card.category"),dataIndex:"categories",width:100,render:r=>e.jsx(e.Fragment,{children:r==null?void 0:r.map(s=>s.name).join(", ")})},{title:t("page.card.tags"),dataIndex:"tags",ellipsis:!0,render:r=>e.jsx(e.Fragment,{children:r==null?void 0:r.map(s=>e.jsx("span",{className:"mr-1",children:s},s))})},{title:t("page.card.popularity"),dataIndex:"popularity",width:100,sorter:!0},{title:t("page.card.chats"),dataIndex:"chats",width:100,sorter:!0},{title:t("page.card.description"),dataIndex:"description",ellipsis:!0},{title:t("page.dataTableExample.action"),key:"actions",fixed:"right",width:100,render:(r,s)=>e.jsxs(e.Fragment,{children:[e.jsx(Ae,{type:"text",size:"small",noText:!0,onClick:()=>i(s.id)}),e.jsx(Re,{type:"text",size:"small",noText:!0,onConfirm:()=>w(s.id)})]})}]});function V(r){console.log("查看角色详情:",r),j(`/card/${r}`)}function i(r){console.log("Edit character with id:",r),L.info({title:"编辑角色",content:`将要编辑 ID 为 ${r} 的角色。`})}function w(r){console.log("Delete character with id:",r),L.confirm({title:"确认删除",content:`确定要删除 ID 为 ${r} 的角色吗？`,onOk:async()=>{try{L.success({content:"删除成功"}),g()}catch{L.error({title:"删除失败",content:"删除角色时出错。"})}}})}function f(){var s;const r=(s=C.rowSelection)==null?void 0:s.selectedRowKeys;if(!Array.isArray(r)||r.length===0){console.warn("No items selected for batch delete.");return}L.confirm({title:"确认批量删除",content:`确定要删除选中的 ${B} 个角色吗？`,onOk:async()=>{try{L.success({content:"批量删除成功"}),g()}catch{L.error({title:"批量删除失败",content:"批量删除角色时出错。"})}}})}const l=()=>{L.confirm({title:"确认退出",content:"确定要退出登录吗？",onOk:()=>{P()}})},d=e.jsxs(K,{ref:a,form:M,colon:!1,autoComplete:"off",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("div",{}),e.jsx(ie,{type:"primary",danger:!0,onClick:l,children:"退出登录"})]}),e.jsxs(Oe,{actions:e.jsxs(e.Fragment,{children:[e.jsxs(Ue,{children:[e.jsx(Be,{loading:W,onClick:J}),e.jsx(Ee,{onClick:g})]}),e.jsx(me,{type:"vertical"}),e.jsx(De,{disabled:Y,count:B,onConfirm:f}),e.jsx(me,{type:"vertical"}),e.jsx(ie,{type:"primary",icon:e.jsx(Ke,{}),loading:A,onClick:E,children:"导入角色"})]}),children:[e.jsxs(ge,{children:[e.jsx(N,{name:"search",label:t("page.card.searchPlaceholder","搜索"),children:e.jsx(ne,{placeholder:t("page.card.searchPlaceholder","按名称、描述搜索...")})}),e.jsx(N,{name:"categoryId",label:t("page.card.category","分类"),children:e.jsx(q,{placeholder:t("page.card.categoryPlaceholder","选择分类"),allowClear:!0,options:o.map(r=>({label:r.name,value:r.id}))})}),e.jsx(N,{name:"visibility",label:t("page.card.visibility","可见性"),children:e.jsx(q,{placeholder:t("page.card.visibilityPlaceholder","选择可见性"),allowClear:!0,options:st})}),e.jsx(N,{name:"status",label:t("page.card.status","状态"),children:e.jsx(q,{placeholder:t("page.card.statusPlaceholder","选择状态"),allowClear:!0,options:at})})]}),e.jsxs(ge,{children:[e.jsx(N,{name:"sortBy",label:t("page.card.sortBy","排序字段"),children:e.jsx(q,{placeholder:t("page.card.sortByPlaceholder","选择排序字段"),options:tt})}),e.jsx(N,{name:"sortOrder",label:t("page.card.sortOrder","排序方式"),children:e.jsx(q,{placeholder:t("page.card.sortOrderPlaceholder","选择排序方式"),options:rt})})]})]})]});function b(){g()}if(!c)return e.jsx(et,{onLoginSuccess:b});const T=()=>{const r=C.dataSource||[];return e.jsx("div",{className:"grid-container",style:{maxHeight:"calc(100vh - 360px)",overflowY:"auto",padding:"10px 5px"},children:e.jsx("div",{className:"grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6",children:r.map(s=>{var x,y,S;return e.jsxs("div",{className:"bg-transparent overflow-hidden cursor-pointer hover:transform hover:scale-[1.03] transition-all",onClick:()=>V(s.id),children:[e.jsxs("div",{className:"relative aspect-square mb-2",children:[e.jsx("div",{className:"w-full h-full rounded-md overflow-hidden",children:e.jsx("img",{src:s.avatarUrl,alt:s.name,className:`w-full h-full object-cover ${s.shouldBlurAvatar?"blur-sm filter":""}`,onError:k=>{const I=k.target;I.onerror=null,I.src=`https://ui-avatars.com/api/?name=${encodeURIComponent(s.name)}&background=random`}})}),e.jsx("div",{className:"absolute bottom-2 left-2",children:e.jsx("span",{className:"bg-card/80 backdrop-blur-sm text-foreground px-3 py-1 rounded-full text-sm",children:((x=s.categories)==null?void 0:x.length)>0?s.categories[0].name:"角色"})})]}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-foreground text-lg font-medium mb-1",children:s.name}),e.jsx("p",{className:"text-muted-foreground text-sm line-clamp-2 mb-2",children:s.description}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("div",{className:"flex items-center gap-1",children:e.jsx("span",{className:"text-muted-foreground text-xs",children:(y=s.tags)==null?void 0:y.join(", ")})}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-4 w-4 text-muted-foreground",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"})}),e.jsx("span",{className:"text-muted-foreground text-xs",children:s.chats||0})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-4 w-4 text-yellow-400",fill:"currentColor",viewBox:"0 0 24 24",stroke:"none",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"})}),e.jsx("span",{className:"text-muted-foreground text-xs",children:((S=s.popularity)==null?void 0:S.toFixed(1))||"0.0"})]})]})]})]})]},s.id)})})})},m=()=>{if(!C.pagination)return null;if(typeof C.pagination=="object"){const{current:r,pageSize:s,total:x,onChange:y}=C.pagination;return e.jsx("div",{className:"mt-4 py-2 flex justify-end",style:{position:"sticky",bottom:0,width:"100%",backgroundColor:"var(--background)",zIndex:10},children:e.jsx(Me,{current:r,pageSize:s,total:x,onChange:y,showSizeChanger:!0,showQuickJumper:!0,showTotal:S=>`共 ${S} 条记录`})})}return null};return e.jsxs(_e,{...R,searchForm:d,children:[T(),m()]})}export{jt as default};
