import{O as ue,P as ce,Q as ie,j as k,g as le,h as fe,V as z,k as he}from"./index-7HAhTflM.js";import{C as W,a5 as me,F as de}from"./antd-C5ilffvX.js";import{g as ge,r as u,f as pe}from"./react-DR1zDSRy.js";import{u as ye}from"./useWindowSize-ncjCtajF.js";import{u as Se,a as G}from"./useMutation-DzVKoaC7.js";import{u as ve}from"./usePageTransfer-BDINMe2W.js";var K,J;function we(){if(J)return K;J=1;var o=typeof Element<"u",l=typeof Map=="function",m=typeof Set=="function",d=typeof ArrayBuffer=="function"&&!!ArrayBuffer.isView;function f(e,t){if(e===t)return!0;if(e&&t&&typeof e=="object"&&typeof t=="object"){if(e.constructor!==t.constructor)return!1;var s,r,h;if(Array.isArray(e)){if(s=e.length,s!=t.length)return!1;for(r=s;r--!==0;)if(!f(e[r],t[r]))return!1;return!0}var g;if(l&&e instanceof Map&&t instanceof Map){if(e.size!==t.size)return!1;for(g=e.entries();!(r=g.next()).done;)if(!t.has(r.value[0]))return!1;for(g=e.entries();!(r=g.next()).done;)if(!f(r.value[1],t.get(r.value[0])))return!1;return!0}if(m&&e instanceof Set&&t instanceof Set){if(e.size!==t.size)return!1;for(g=e.entries();!(r=g.next()).done;)if(!t.has(r.value[0]))return!1;return!0}if(d&&ArrayBuffer.isView(e)&&ArrayBuffer.isView(t)){if(s=e.length,s!=t.length)return!1;for(r=s;r--!==0;)if(e[r]!==t[r])return!1;return!0}if(e.constructor===RegExp)return e.source===t.source&&e.flags===t.flags;if(e.valueOf!==Object.prototype.valueOf&&typeof e.valueOf=="function"&&typeof t.valueOf=="function")return e.valueOf()===t.valueOf();if(e.toString!==Object.prototype.toString&&typeof e.toString=="function"&&typeof t.toString=="function")return e.toString()===t.toString();if(h=Object.keys(e),s=h.length,s!==Object.keys(t).length)return!1;for(r=s;r--!==0;)if(!Object.prototype.hasOwnProperty.call(t,h[r]))return!1;if(o&&e instanceof Element)return!1;for(r=s;r--!==0;)if(!((h[r]==="_owner"||h[r]==="__v"||h[r]==="__o")&&e.$$typeof)&&!f(e[h[r]],t[h[r]]))return!1;return!0}return e!==e&&t!==t}return K=function(t,s){try{return f(t,s)}catch(r){if((r.message||"").match(/stack|recursion/i))return console.warn("react-fast-compare cannot handle circular refs"),!1;throw r}},K}var Re=we();const Ce=ge(Re);var Te=function(o,l){return o===void 0&&(o=[]),l===void 0&&(l=[]),Ce(o,l)},xe=function(o,l,m){var d=u.useRef(),f=u.useRef(0);Te(l,d.current)||(f.current+=1),d.current=l,ue(o,[f.current],m)},Pe=function(o,l,m){m===void 0&&(m={});var d=ce(o);xe(function(){var f=ie(l);if(f){var e=new MutationObserver(d.current);return e.observe(f,m),function(){e==null||e.disconnect()}}},[m],l)};function He({searchCardRef:o,tableCardHeight:l,children:m,searchForm:d}){return k.jsxDEV("div",{className:"m-2 flex flex-col items-stretch gap-2 overflow-hidden lt-sm:overflow-auto",children:[d&&k.jsxDEV(W,{ref:o,size:"small",variant:"borderless",children:d},void 0,!1,{fileName:"/home/runner/work/pure-admin-react/pure-admin-react/src/components/container/SearchTableContainer.tsx",lineNumber:21,columnNumber:7},this),k.jsxDEV(W,{style:{height:`${l}px`},size:"small",variant:"borderless",children:m},void 0,!1,{fileName:"/home/runner/work/pure-admin-react/pure-admin-react/src/components/container/SearchTableContainer.tsx",lineNumber:30,columnNumber:7},this)]},void 0,!0,{fileName:"/home/runner/work/pure-admin-react/pure-admin-react/src/components/container/SearchTableContainer.tsx",lineNumber:19,columnNumber:5},this)}function Ee(){const{token:o}=me.useToken(),{height:l}=ye(),{headerHeight:m}=le(fe(c=>({headerHeight:c.headerHeight}))),d=u.useRef(null),f=z(d),e=(f==null?void 0:f.height)||0,t=Number.parseFloat(getComputedStyle(document.documentElement).fontSize)*.5,s=l-m-e-t*3,[r,h]=u.useState(null),g=z(r),O=(g==null?void 0:g.height)||0,[H,E]=u.useState(null),q=z(H),w=(q==null?void 0:q.height)||0,[A,a]=u.useState(null),F=z(A),p=(F==null?void 0:F.height)||0,R=()=>{const c=document.querySelector(".ant-table-thead");c&&h(c)},C=()=>{const c=document.querySelector(".ant-table-tbody");c&&E(c)},T=()=>{const c=document.querySelector(".ant-table-pagination");c&&a(c)},x=()=>{R(),C(),T()};u.useEffect(()=>{x()},[]);const M=u.useRef(document.body);Pe(()=>{x()},M,{childList:!0,subtree:!0});const j=u.useMemo(()=>{const b=s-O-p-o.margin*2-6;return w>=b?b:void 0},[s,O,p,o.margin,w]);return{listContainerProps:u.useMemo(()=>({searchCardRef:d,tableCardHeight:s}),[e,s]),tableScrollY:j}}function Y(o){return!Array.isArray(o)&&"total"in o&&"list"in o}function Qe({listApiFn:o,deleteApiFn:l,batchDeleteApiFn:m,key:d,idKey:f="id",cacheEnabled:e=!0,dataStaleTime:t=1e3*60*10,pagination:s=!0,selectable:r=!1,formInitialValues:h={},columns:g,scrollX:O="100%",scrollY:H,pageCreatePath:E,pageEditPath:q}){const{navigateWithData:w}=ve(),A=Object.keys(h).length>0,[a]=A?de.useForm():[null],F=pe(),p=he(),[R,C]=u.useState(1),[T,x]=u.useState(10),[M,j]=u.useState(h),[v,c]=u.useState([]),b=u.useMemo(()=>v.length,[v]),Z=u.useMemo(()=>b===0,[b]),D=`${d}-list`,P=`${d}-list-state`,X=()=>{e&&p.removeQueries({queryKey:[P]})};u.useEffect(()=>{if(e){const n=p.getQueryData([P]);n?(a==null||a.setFieldsValue(n.params),j(n.params),s&&(C(n.page),x(n.pageSize))):a==null||a.setFieldsValue(h)}else a==null||a.setFieldsValue(h)},[e,a,h,s,p,P]);const{data:S,refetch:V,isLoading:L}=Se({queryKey:[D,M,R,T],queryFn:async()=>{try{const n={...M};console.log("useTable queryFn - queryState:",M),console.log("useTable queryFn - baseParams:",n);let i;if(s){const y={...n,page:R,pageSize:T};console.log("useTable queryFn - finalParams:",y),i=await o(y)}else i=await o(n);return i}catch(n){throw console.error("查询执行失败:",n),n}},staleTime:e?t:0,gcTime:e?t:0}),_=G({mutationFn:l,onSuccess:()=>{p.invalidateQueries({queryKey:[D]})}}),U=G({mutationFn:m,onSuccess:()=>{p.invalidateQueries({queryKey:[D]}),c([])}}),I=async()=>{try{const n=a?await a.validateFields():{};console.log("handleSearch - form values:",n);const i=Object.keys(n).reduce((y,Q)=>{const N=n[Q];return N!=null&&N!==""&&(y[Q]=N),y},{});if(console.log("handleSearch - 清理后的值:",i),j(i),console.log("handleSearch - 设置新的 queryState:",i),e){const y={params:i,page:1,pageSize:10};p.setQueryData([P],y)}s&&C(1),c([])}catch(n){console.error("查询表单验证失败:",n)}},ee=async()=>{if(a==null||a.resetFields(),j(h),e){const n={params:h,page:1,pageSize:10};p.setQueryData([P],n)}s&&(C(1),x(10)),c([])},te=(n=null,i={})=>{w(E?{pathname:E,search:new URLSearchParams(i).toString()}:{pathname:`${F.pathname}/create/new`,search:new URLSearchParams(i).toString()},n)},re=(n,i=null,y={})=>{const Q=n;w(q?{pathname:q,search:new URLSearchParams(y).toString()}:{pathname:`${F.pathname}/edit/${Q[f]}`,search:new URLSearchParams(y).toString()},i)},ne=async n=>{l&&await _.mutateAsync(n)},se=async()=>{m&&v.length>0&&await U.mutateAsync(v)},$=u.useMemo(()=>S?Y(S)?S.list:S:[],[S]),B=u.useMemo(()=>S?Y(S)?S.total:S.length:0,[S]),ae=u.useCallback((n,i)=>{if(C(n),x(i),e){const y={params:{...a==null?void 0:a.getFieldsValue()},page:n,pageSize:i};p.setQueryData([P],y)}c([])},[e,a,p,P]),oe=u.useMemo(()=>({rowKey:f,columns:g,dataSource:$,loading:L,sticky:!0,...r?{rowSelection:{type:"checkbox",selectedRowKeys:v,onChange:n=>{c(n.map(i=>Number(i)))}}}:{},scroll:{x:O,y:H},pagination:s?{current:R,pageSize:T,total:B,onChange:ae}:!1}),[f,g,$,L,r,v,O,H,s,R,T,B,V]);return{form:a,tableProps:oe,isLoading:L,isDeleting:_.isPending,isBatchDeleting:U.isPending,data:S,list:$,total:B,handleSearch:I,handleReset:ee,handleCreate:te,handleEdit:re,handleDelete:ne,handleBatchDelete:se,selectedState:v,selectedCount:b,selectedIsEmpty:Z,setSelectedState:c,resetSelectedState:()=>c([]),clearSavedState:X,refetch:V,...s?{currentPage:R,currentPageSize:T,setPage:C,setPageSize:x}:{}}}export{He as S,Qe as a,Ee as u};
