import{aJ as oe,aK as ue,aL as ie,j as D,m as ce,n as fe,aM as E,aN as le}from"./index-bnCn0n-D.js";import{c as W,t as he,F as de}from"./antd-BKYABR1U.js";import{g as ge,r as u,i as pe}from"./react-Dz_Dwpfc.js";import{u as ye}from"./useWindowSize-DSNN33pu.js";import{u as me,a as b}from"./useMutation-B-lWSa9s.js";import{u as Se}from"./usePageTransfer-Bi3KoAVq.js";var _,k;function ve(){if(k)return _;k=1;var o=typeof Element<"u",c=typeof Map=="function",h=typeof Set=="function",d=typeof ArrayBuffer=="function"&&!!ArrayBuffer.isView;function f(e,t){if(e===t)return!0;if(e&&t&&typeof e=="object"&&typeof t=="object"){if(e.constructor!==t.constructor)return!1;var s,r,l;if(Array.isArray(e)){if(s=e.length,s!=t.length)return!1;for(r=s;r--!==0;)if(!f(e[r],t[r]))return!1;return!0}var g;if(c&&e instanceof Map&&t instanceof Map){if(e.size!==t.size)return!1;for(g=e.entries();!(r=g.next()).done;)if(!t.has(r.value[0]))return!1;for(g=e.entries();!(r=g.next()).done;)if(!f(r.value[1],t.get(r.value[0])))return!1;return!0}if(h&&e instanceof Set&&t instanceof Set){if(e.size!==t.size)return!1;for(g=e.entries();!(r=g.next()).done;)if(!t.has(r.value[0]))return!1;return!0}if(d&&ArrayBuffer.isView(e)&&ArrayBuffer.isView(t)){if(s=e.length,s!=t.length)return!1;for(r=s;r--!==0;)if(e[r]!==t[r])return!1;return!0}if(e.constructor===RegExp)return e.source===t.source&&e.flags===t.flags;if(e.valueOf!==Object.prototype.valueOf&&typeof e.valueOf=="function"&&typeof t.valueOf=="function")return e.valueOf()===t.valueOf();if(e.toString!==Object.prototype.toString&&typeof e.toString=="function"&&typeof t.toString=="function")return e.toString()===t.toString();if(l=Object.keys(e),s=l.length,s!==Object.keys(t).length)return!1;for(r=s;r--!==0;)if(!Object.prototype.hasOwnProperty.call(t,l[r]))return!1;if(o&&e instanceof Element)return!1;for(r=s;r--!==0;)if(!((l[r]==="_owner"||l[r]==="__v"||l[r]==="__o")&&e.$$typeof)&&!f(e[l[r]],t[l[r]]))return!1;return!0}return e!==e&&t!==t}return _=function(t,s){try{return f(t,s)}catch(r){if((r.message||"").match(/stack|recursion/i))return console.warn("react-fast-compare cannot handle circular refs"),!1;throw r}},_}var Re=ve();const we=ge(Re);var Ce=function(o,c){return o===void 0&&(o=[]),c===void 0&&(c=[]),we(o,c)},xe=function(o,c,h){var d=u.useRef(),f=u.useRef(0);Ce(c,d.current)||(f.current+=1),d.current=c,oe(o,[f.current],h)},Me=function(o,c,h){h===void 0&&(h={});var d=ue(o);xe(function(){var f=ie(c);if(f){var e=new MutationObserver(d.current);return e.observe(f,h),function(){e==null||e.disconnect()}}},[h],c)};function He({searchCardRef:o,tableCardHeight:c,children:h,searchForm:d}){return D.jsxs("div",{className:"m-2 flex flex-col items-stretch gap-2 overflow-hidden lt-sm:overflow-auto",children:[d&&D.jsx(W,{ref:o,size:"small",variant:"borderless",children:d}),D.jsx(W,{style:{height:`${c}px`},size:"small",variant:"borderless",children:h})]})}function Qe(){const{token:o}=he.useToken(),{height:c}=ye(),{headerHeight:h}=ce(fe(i=>({headerHeight:i.headerHeight}))),d=u.useRef(null),f=E(d),e=(f==null?void 0:f.height)||0,t=Number.parseFloat(getComputedStyle(document.documentElement).fontSize)*.5,s=c-h-e-t*3,[r,l]=u.useState(null),g=E(r),O=(g==null?void 0:g.height)||0,[j,q]=u.useState(null),P=E(j),v=(P==null?void 0:P.height)||0,[A,a]=u.useState(null),T=E(A),p=(T==null?void 0:T.height)||0,R=()=>{const i=document.querySelector(".ant-table-thead");i&&l(i)},w=()=>{const i=document.querySelector(".ant-table-tbody");i&&q(i)},C=()=>{const i=document.querySelector(".ant-table-pagination");i&&a(i)},x=()=>{R(),w(),C()};u.useEffect(()=>{x()},[]);const H=u.useRef(document.body);Me(()=>{x()},H,{childList:!0,subtree:!0});const Q=u.useMemo(()=>{const F=s-O-p-o.margin*2-6;return v>=F?F:void 0},[s,O,p,o.margin,v]);return{listContainerProps:u.useMemo(()=>({searchCardRef:d,tableCardHeight:s}),[e,s]),tableScrollY:Q}}function J(o){return!Array.isArray(o)&&"total"in o&&"list"in o}function ze({listApiFn:o,deleteApiFn:c,batchDeleteApiFn:h,key:d,idKey:f="id",cacheEnabled:e=!0,dataStaleTime:t=1e3*60*10,pagination:s=!0,selectable:r=!1,formInitialValues:l={},columns:g,scrollX:O="100%",scrollY:j,pageCreatePath:q,pageEditPath:P}){const{navigateWithData:v}=Se(),A=Object.keys(l).length>0,[a]=A?de.useForm():[null],T=pe(),p=le(),[R,w]=u.useState(1),[C,x]=u.useState(10),[H,Q]=u.useState(l),[S,i]=u.useState([]),F=u.useMemo(()=>S.length,[S]),V=u.useMemo(()=>F===0,[F]),L=`${d}-list`,M=`${d}-list-state`,G=()=>{e&&p.removeQueries({queryKey:[M]})};u.useEffect(()=>{if(e){const n=p.getQueryData([M]);n?(a==null||a.setFieldsValue(n.params),Q(n.params),s&&(w(n.page),x(n.pageSize))):a==null||a.setFieldsValue(l)}else a==null||a.setFieldsValue(l)},[e,a,l,s,p,M]);const{data:m,refetch:Y,isLoading:$}=me({queryKey:[L,H,R,C],queryFn:async()=>{const n={...H};return s?await o({...n,page:R,pageSize:C}):await o(n)},staleTime:e?t:0,gcTime:e?t:0}),N=b({mutationFn:c,onSuccess:()=>{p.invalidateQueries({queryKey:[L]})}}),U=b({mutationFn:h,onSuccess:()=>{p.invalidateQueries({queryKey:[L]}),i([])}}),Z=async()=>{try{const n=await(a==null?void 0:a.validateFields());if(e){const y={params:n,page:1,pageSize:10};p.setQueryData([M],y)}s&&w(1),i([])}catch(n){console.error("Search form validation failed:",n)}},X=async()=>{if(a==null||a.resetFields(),Q(l),e){const n={params:l,page:1,pageSize:10};p.setQueryData([M],n)}s&&(w(1),x(10)),i([])},I=(n=null,y={})=>{v(q?{pathname:q,search:new URLSearchParams(y).toString()}:{pathname:`${T.pathname}/create/new`,search:new URLSearchParams(y).toString()},n)},ee=(n,y=null,z={})=>{const ae=n;v(P?{pathname:P,search:new URLSearchParams(z).toString()}:{pathname:`${T.pathname}/edit/${ae[f]}`,search:new URLSearchParams(z).toString()},y)},te=async n=>{c&&await N.mutateAsync(n)},re=async()=>{h&&S.length>0&&await U.mutateAsync(S)},B=u.useMemo(()=>m?J(m)?m.list:m:[],[m]),K=u.useMemo(()=>m?J(m)?m.total:m.length:0,[m]),se=u.useCallback((n,y)=>{if(w(n),x(y),e){const z={params:{...a==null?void 0:a.getFieldsValue()},page:n,pageSize:y};p.setQueryData([M],z)}i([])},[e,a,p,M]),ne=u.useMemo(()=>({rowKey:f,columns:g,dataSource:B,loading:$,sticky:!0,...r?{rowSelection:{type:"checkbox",selectedRowKeys:S,onChange:n=>{i(n.map(y=>Number(y)))}}}:{},scroll:{x:O,y:j},pagination:s?{current:R,pageSize:C,total:K,onChange:se}:!1}),[f,g,B,$,r,S,O,j,s,R,C,K,Y]);return{form:a,tableProps:ne,isLoading:$,isDeleting:N.isPending,isBatchDeleting:U.isPending,data:m,list:B,total:K,handleSearch:Z,handleReset:X,handleCreate:I,handleEdit:ee,handleDelete:te,handleBatchDelete:re,selectedState:S,selectedCount:F,selectedIsEmpty:V,setSelectedState:i,resetSelectedState:()=>i([]),clearSavedState:G,...s?{currentPage:R,currentPageSize:C,setPage:w,setPageSize:x}:{}}}export{He as S,ze as a,Qe as u};
