import{aI as oe,aJ as ue,aK as ce,j as D,n as ie,o as fe,aL as E,aM as le}from"./index-DHn59PON.js";import{c as N,t as he,F as de}from"./antd-Bzi-nNZC.js";import{g as ge,r as u,j as pe}from"./react-DNsX-D9n.js";import{u as ye}from"./useWindowSize-CaV-WCuS.js";import{u as me,a as k}from"./useMutation-DMmFNPI2.js";import{u as Se}from"./usePageTransfer-vDIHryUH.js";var _,J;function ve(){if(J)return _;J=1;var o=typeof Element<"u",i=typeof Map=="function",d=typeof Set=="function",g=typeof ArrayBuffer=="function"&&!!ArrayBuffer.isView;function f(e,t){if(e===t)return!0;if(e&&t&&typeof e=="object"&&typeof t=="object"){if(e.constructor!==t.constructor)return!1;var n,r,l;if(Array.isArray(e)){if(n=e.length,n!=t.length)return!1;for(r=n;r--!==0;)if(!f(e[r],t[r]))return!1;return!0}var p;if(i&&e instanceof Map&&t instanceof Map){if(e.size!==t.size)return!1;for(p=e.entries();!(r=p.next()).done;)if(!t.has(r.value[0]))return!1;for(p=e.entries();!(r=p.next()).done;)if(!f(r.value[1],t.get(r.value[0])))return!1;return!0}if(d&&e instanceof Set&&t instanceof Set){if(e.size!==t.size)return!1;for(p=e.entries();!(r=p.next()).done;)if(!t.has(r.value[0]))return!1;return!0}if(g&&ArrayBuffer.isView(e)&&ArrayBuffer.isView(t)){if(n=e.length,n!=t.length)return!1;for(r=n;r--!==0;)if(e[r]!==t[r])return!1;return!0}if(e.constructor===RegExp)return e.source===t.source&&e.flags===t.flags;if(e.valueOf!==Object.prototype.valueOf&&typeof e.valueOf=="function"&&typeof t.valueOf=="function")return e.valueOf()===t.valueOf();if(e.toString!==Object.prototype.toString&&typeof e.toString=="function"&&typeof t.toString=="function")return e.toString()===t.toString();if(l=Object.keys(e),n=l.length,n!==Object.keys(t).length)return!1;for(r=n;r--!==0;)if(!Object.prototype.hasOwnProperty.call(t,l[r]))return!1;if(o&&e instanceof Element)return!1;for(r=n;r--!==0;)if(!((l[r]==="_owner"||l[r]==="__v"||l[r]==="__o")&&e.$$typeof)&&!f(e[l[r]],t[l[r]]))return!1;return!0}return e!==e&&t!==t}return _=function(t,n){try{return f(t,n)}catch(r){if((r.message||"").match(/stack|recursion/i))return console.warn("react-fast-compare cannot handle circular refs"),!1;throw r}},_}var Re=ve();const we=ge(Re);var Ce=function(o,i){return o===void 0&&(o=[]),i===void 0&&(i=[]),we(o,i)},xe=function(o,i,d){var g=u.useRef(),f=u.useRef(0);Ce(i,g.current)||(f.current+=1),g.current=i,oe(o,[f.current],d)},Me=function(o,i,d){d===void 0&&(d={});var g=ue(o);xe(function(){var f=ce(i);if(f){var e=new MutationObserver(g.current);return e.observe(f,d),function(){e==null||e.disconnect()}}},[d],i)};function He({searchCardRef:o,tableCardHeight:i,children:d,searchForm:g}){return D.jsxs("div",{className:"m-2 flex flex-col items-stretch gap-2 overflow-hidden lt-sm:overflow-auto",children:[g&&D.jsx(N,{ref:o,size:"small",variant:"borderless",children:g}),D.jsx(N,{style:{height:`${i}px`},size:"small",variant:"borderless",children:d})]})}function Qe(){const{token:o}=he.useToken(),{height:i}=ye(),{headerHeight:d}=ie(fe(c=>({headerHeight:c.headerHeight}))),g=u.useRef(null),f=E(g),e=(f==null?void 0:f.height)||0,t=Number.parseFloat(getComputedStyle(document.documentElement).fontSize)*.5,n=i-d-e-t*3,[r,l]=u.useState(null),p=E(r),F=(p==null?void 0:p.height)||0,[O,q]=u.useState(null),P=E(O),v=(P==null?void 0:P.height)||0,[A,a]=u.useState(null),T=E(A),y=(T==null?void 0:T.height)||0,R=()=>{const c=document.querySelector(".ant-table-thead");c&&l(c)},w=()=>{const c=document.querySelector(".ant-table-tbody");c&&q(c)},C=()=>{const c=document.querySelector(".ant-table-pagination");c&&a(c)},x=()=>{R(),w(),C()};u.useEffect(()=>{x()},[]);const H=u.useRef(document.body);Me(()=>{x()},H,{childList:!0,subtree:!0});const Q=u.useMemo(()=>{const j=n-F-y-o.margin*2-6;return v>=j?j:void 0},[n,F,y,o.margin,v]);return{listContainerProps:u.useMemo(()=>({searchCardRef:g,tableCardHeight:n}),[e,n]),tableScrollY:Q}}function V(o){return!Array.isArray(o)&&"total"in o&&"list"in o}function ze({listApiFn:o,deleteApiFn:i,batchDeleteApiFn:d,key:g,idKey:f="id",cacheEnabled:e=!0,dataStaleTime:t=1e3*60*10,pagination:n=!0,selectable:r=!1,formInitialValues:l={},columns:p,scrollX:F="100%",scrollY:O,pageCreatePath:q,pageEditPath:P}){const{navigateWithData:v}=Se(),A=Object.keys(l).length>0,[a]=A?de.useForm():[null],T=pe(),y=le(),[R,w]=u.useState(1),[C,x]=u.useState(10),[H,Q]=u.useState(l),[S,c]=u.useState([]),j=u.useMemo(()=>S.length,[S]),G=u.useMemo(()=>j===0,[j]),L=`${g}-list`,M=`${g}-list-state`,Y=()=>{e&&y.removeQueries({queryKey:[M]})};u.useEffect(()=>{if(e){const s=y.getQueryData([M]);s?(a==null||a.setFieldsValue(s.params),Q(s.params),n&&(w(s.page),x(s.pageSize))):a==null||a.setFieldsValue(l)}else a==null||a.setFieldsValue(l)},[e,a,l,n,y,M]);const{data:m,refetch:U,isLoading:$}=me({queryKey:[L,H,R,C],queryFn:async()=>{try{const s={...H};let h;return n?h=await o({...s,page:R,pageSize:C}):h=await o(s),h}catch(s){throw console.error("查询执行失败:",s),s}},staleTime:e?t:0,gcTime:e?t:0}),W=k({mutationFn:i,onSuccess:()=>{y.invalidateQueries({queryKey:[L]})}}),b=k({mutationFn:d,onSuccess:()=>{y.invalidateQueries({queryKey:[L]}),c([])}}),Z=async()=>{try{const s=await(a==null?void 0:a.validateFields());if(e){const h={params:s,page:1,pageSize:10};y.setQueryData([M],h)}n&&w(1),c([])}catch(s){console.error("查询表单验证失败:",s)}},X=async()=>{if(a==null||a.resetFields(),Q(l),e){const s={params:l,page:1,pageSize:10};y.setQueryData([M],s)}n&&(w(1),x(10)),c([])},I=(s=null,h={})=>{v(q?{pathname:q,search:new URLSearchParams(h).toString()}:{pathname:`${T.pathname}/create/new`,search:new URLSearchParams(h).toString()},s)},ee=(s,h=null,z={})=>{const ae=s;v(P?{pathname:P,search:new URLSearchParams(z).toString()}:{pathname:`${T.pathname}/edit/${ae[f]}`,search:new URLSearchParams(z).toString()},h)},te=async s=>{i&&await W.mutateAsync(s)},re=async()=>{d&&S.length>0&&await b.mutateAsync(S)},B=u.useMemo(()=>m?V(m)?m.list:m:[],[m]),K=u.useMemo(()=>m?V(m)?m.total:m.length:0,[m]),se=u.useCallback((s,h)=>{if(w(s),x(h),e){const z={params:{...a==null?void 0:a.getFieldsValue()},page:s,pageSize:h};y.setQueryData([M],z)}c([])},[e,a,y,M]),ne=u.useMemo(()=>({rowKey:f,columns:p,dataSource:B,loading:$,sticky:!0,...r?{rowSelection:{type:"checkbox",selectedRowKeys:S,onChange:s=>{c(s.map(h=>Number(h)))}}}:{},scroll:{x:F,y:O},pagination:n?{current:R,pageSize:C,total:K,onChange:se}:!1}),[f,p,B,$,r,S,F,O,n,R,C,K,U]);return{form:a,tableProps:ne,isLoading:$,isDeleting:W.isPending,isBatchDeleting:b.isPending,data:m,list:B,total:K,handleSearch:Z,handleReset:X,handleCreate:I,handleEdit:ee,handleDelete:te,handleBatchDelete:re,selectedState:S,selectedCount:j,selectedIsEmpty:G,setSelectedState:c,resetSelectedState:()=>c([]),clearSavedState:Y,refetch:U,...n?{currentPage:R,currentPageSize:C,setPage:w,setPageSize:x}:{}}}export{He as S,ze as a,Qe as u};
